# CLAUDE.ru.md

Этот файл предоставляет рекомендации для Claude Code (claude.ai/code) при работе с кодом в этом репозитории.

## Обзор проекта

**Paired** - API на основе NestJS для приложения с вопросами для пар. API позволяет парам создавать отношения, получать ежедневные вопросы, отправлять ответы и общаться через WebSockets.

## Команды для разработки

### Установка и настройка
```bash
npm install
npx prisma generate           # Генерация Prisma клиента после изменений схемы
npx prisma migrate dev        # Создание и применение миграций в разработке
npx prisma migrate deploy     # Применение миграций в продакшене
```

### Запуск приложения
```bash
npm run start:dev             # Режим разработки с автоперезагрузкой
npm run start:debug           # Режим отладки с автоперезагрузкой
npm run start:prod            # Продакшн режим
```

### Тестирование и качество кода
```bash
npm run test                  # Запуск юнит-тестов
npm run test:watch            # Запуск тестов в режиме отслеживания
npm run test:cov              # Запуск тестов с покрытием
npm run test:e2e              # Запуск end-to-end тестов
npm run lint                  # Линтинг и исправление TypeScript файлов
npm run format                # Форматирование кода с Prettier
```

### Сборка и база данных
```bash
npm run build                 # Сборка проекта
npx prisma studio             # Открыть Prisma Studio GUI для базы данных
```

## Архитектура и паттерны

### Структура модулей

Приложение следует модульной архитектуре NestJS с 6 основными функциональными модулями:

1. **AuthModule** - JWT-аутентификация (passport-jwt)
   - Использует JwtStrategy для валидации токенов
   - Guards защищают роуты, требующие аутентификации
   - Переменные окружения: `JWT_SECRET`, `JWT_EXPIRES_IN`

2. **UserModule** - Управление пользователями
   - Обрабатывает создание пользователей, профили, аватары
   - Пользователи могут принадлежать одной паре через `coupleId`

3. **CoupleModule** - Управление отношениями
   - Система инвайт-кодов для создания пары (6-символьные UUID в верхнем регистре)
   - Пары ограничены 2 пользователями
   - Управляет метаданными отношений (дата начала, время уведомлений, тип)

4. **QuestionModule** - Каталог вопросов и распределение
   - Назначение ежедневных вопросов для каждой пары
   - Вопросы категоризированы (GENERAL, INTIMACY, COMMUNICATION и т.д.)
   - Несколько типов ответов (TEXT, SCALE, CHOICE, YESNO)
   - `getTodayQuestion()` создает CoupleQuestion, если его нет на сегодня

5. **AnswerModule** - Ответы пользователей на вопросы
   - Ответы связаны с CoupleQuestion (много пар могут отвечать на один Question)
   - Один ответ на пользователя на CoupleQuestion
   - Разные поля значений в зависимости от типа ответа

6. **MessageModule** - Чат в реальном времени через WebSocket
   - Gateway namespace: `/messages`
   - Сообщения связаны с CoupleQuestions
   - Socket.io для двунаправленной коммуникации

### Схема базы данных (Prisma + PostgreSQL)

Ключевые связи:
- **User** → Couple (многие к одному через `coupleId`)
- **Couple** ↔ User (один ко многим, максимум 2 пользователя)
- **Question** ← CoupleQuestion → Couple (промежуточная таблица для распределения вопросов)
- **CoupleQuestion** → Answer (один ко многим, максимум 2 ответа на пару)
- **CoupleQuestion** → Message (один ко многим для обсуждений)

**Важно**: CoupleQuestion - это центральная точка. Она представляет конкретный вопрос, отправленный конкретной паре в конкретное время. Все ответы и сообщения ссылаются на CoupleQuestion, а не на Question напрямую.

### Структура API

- Глобальный префикс: `/api`
- Swagger документация: `/api/docs`
- Все роуты используют ValidationPipe для валидации DTO
- JWT Bearer аутентификация через `@nestjs/passport`

### Поток аутентификации

1. Пользователь регистрируется/входит через AuthController
2. JwtStrategy валидирует токены используя `JWT_SECRET`
3. Защищенные роуты используют `@UseGuards(JwtGuard)`
4. Декоратор `@CurrentUser()` извлекает пользователя из JWT payload

### Общие паттерны

**Слой сервисов**: Вся бизнес-логика находится в сервисах, инжектируется `PrismaService`
- Контроллеры тонкие, делегируют работу сервисам
- Сервисы обрабатывают валидацию, запросы к БД и выбрасывание ошибок

**DTO**: Валидация входных данных с помощью декораторов class-validator
- Create/Update DTO для каждого модуля
- Swagger декораторы для документации API

**Обработка ошибок**: Сервисы выбрасывают HTTP исключения
- `NotFoundException` - Ресурс не найден
- `ConflictException` - Нарушение бизнес-правил (например, пользователь уже в паре)

**Запросы к БД**: Всегда включайте связи, необходимые для ответа
- Используйте Prisma `include` для получения связанных данных
- Используйте `select` для ограничения возвращаемых полей (никогда не возвращайте пароли)

## Важные детали реализации

### Создание и присоединение к паре

**Создание пары**:
- Генерирует уникальный 6-символьный инвайт-код
- Пользователь не должен быть уже в паре
- Автоматически подключает создающего пользователя к паре

**Присоединение к паре**:
- Если пользователь в паре из одного человека, сначала удалить её
- Если пользователь в паре из 2 человек, отклонить с ошибкой конфликта
- В паре должно быть меньше 2 пользователей

**Выход из пары**:
- Если последний пользователь в паре, удалить пару
- Иначе, просто отключить пользователя

### Логика ежедневных вопросов (QuestionService.getTodayQuestion)

1. Проверить, есть ли у пары вопрос на сегодня (используя диапазон дат)
2. Если нет, найти следующий неиспользованный вопрос (по порядку ID) где `isActive = true`
3. Создать запись CoupleQuestion
4. Вернуть вопрос с флагами статуса ответов

Это гарантирует, что каждая пара получает один новый вопрос в день, проходя через доступные вопросы.

### Реализация WebSocket

MessageGateway использует Socket.io с namespace `/messages`:
- Клиенты подключаются к `ws://host/messages`
- Используйте `@SubscribeMessage('message')` для обработчиков событий
- Отправляйте события через `this.server.emit()` для broadcast

## Docker развертывание

Многоэтапная сборка:
1. **Builder stage**: Установка зависимостей, сборка приложения, генерация Prisma клиента
2. **Runtime stage**: Копирование собранных артефактов, только продакшн зависимости
3. Запуск миграций при старте: `npx prisma migrate deploy && node dist/main`
4. Открывает порт 3001

## Необходимые переменные окружения

- `DATABASE_URL` - Строка подключения к PostgreSQL
- `JWT_SECRET` - Секрет для подписи JWT токенов
- `JWT_EXPIRES_IN` - Время истечения токена (например, "7d", "24h")
- `PORT` - Опционально, по умолчанию 3001

## Соглашения по тестированию

- Юнит-тесты используют Jest с ts-jest
- Тестовые файлы: `*.spec.ts` в директории `src/`
- E2E тесты в директории `test/`
- Мокируйте PrismaService для юнит-тестов
